# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a PostgreSQL Database Console built with Electron, React, and Vite. It provides a desktop application for connecting to multiple PostgreSQL servers, selecting databases, and executing SQL queries with a Monaco-based editor.

## Development Commands

```bash
# Install dependencies
npm install

# Run in development mode (starts both React dev server and Electron)
npm run dev

# Build React application for production
npm run build

# Build Electron application (creates distributable)
npm run build:electron

# Run React preview server
npm preview
```

## Architecture

### Electron Process Architecture

The application follows Electron's multi-process architecture with strict security boundaries:

**Main Process (`electron/main.js`)**
- Creates BrowserWindow with `contextIsolation: true` and `nodeIntegration: false`
- Manages IPC handlers for database operations
- Uses `electron-store` v10.0.0 for persistent credential storage
- Handles window lifecycle and development vs production loading

**Preload Script (`electron/preload.js`)**
- Exposes `window.electronAPI` to renderer via `contextBridge`
- Provides secure IPC communication methods
- All database operations go through this API boundary

**Renderer Process (React App)**
- No direct Node.js or Electron API access
- Communicates with main process exclusively via `window.electronAPI`

### Database Connection Management

**Connection Pooling (`electron/database/connection.js`)**
- Maintains a `Map` of connection pools keyed by `serverId:database`
- Pools are lazy-loaded on first use and cached
- Pools are cleared when credentials change via `setCredentials()`
- Default pool settings: max 10 connections, 30s idle timeout, 5s connection timeout

**Credentials Flow**
1. Credentials stored in `electron-store` under `serverCredentials` key
2. Can be loaded from `config/servers.json` as fallback
3. Required JSON structure:
   ```json
   {
     "servers": [
       {
         "id": "unique-id",
         "name": "Display Name",
         "host": "hostname",
         "port": 5432,
         "user": "username",
         "password": "password"
       }
     ]
   }
   ```
4. Credentials loaded in-memory via `setCredentials()` which clears existing pools

**Query Execution (`electron/database/query-executor.js`)**
- Auto-detects query type (SELECT, DML, DDL, OTHER)
- Returns different response structures based on query type:
  - SELECT: includes `rows`, `fields`, `rowCount`, `executionTime`
  - DML: includes `rowCount`, `command`, `executionTime`, `message`
  - DDL: includes `command`, `executionTime`, `message`
- All queries require both serverId and database selection

### React Component Hierarchy

```
App.jsx (root component)
├── CredentialsManager.jsx (upload/manage server credentials)
├── ServerSelector.jsx (dropdown for server selection)
├── DatabaseSelector.jsx (dropdown for database selection)
├── SqlEditor.jsx (Monaco editor for SQL queries)
└── ResultsViewer.jsx (displays query results in tables)
```

**State Management**
- All state managed in `App.jsx` using React hooks
- State flows down via props, callbacks flow up
- Key state: `credentialsLoaded`, `selectedServer`, `selectedDatabase`, `query`, `result`

**IPC Service Layer (`src/services/ipc.js`)**
- Thin wrapper around `window.electronAPI`
- Centralizes error handling for IPC calls
- Returns consistent `{ success, data/error }` structure

### Important Constraints

**Module System**
- Electron main process uses CommonJS (`require`/`module.exports`)
- React frontend uses ES modules (`import`/`export`)
- `electron-store` must be locked at v8.2.0 (v9+ is ESM-only and incompatible with CommonJS main process)
- CRITICAL: Do not upgrade electron-store beyond v8.2.0 as it will break the application

**Security**
- Never expose PostgreSQL credentials to renderer process
- All database operations executed in main process
- Credentials stored encrypted via `electron-store`
- preload script is the only bridge between main and renderer

**Database Connection Lifecycle**
- Pools persist across queries to the same server+database
- Pools automatically cleared when credentials change
- Failed connections throw errors to be handled by IPC handlers

## File Structure Notes

- `electron/` - All Electron main process code (CommonJS)
  - `database/` - PostgreSQL connection and query execution logic
- `src/` - React frontend code (ES modules)
  - `components/` - React UI components
  - `services/` - IPC communication wrappers
- `config/` - Optional server configuration files
- `assets/` - Application icons and resources
- `dist/` - Built React app (generated by Vite)

## Development Notes

When modifying IPC communication:
1. Add handler in `electron/main.js` using `ipcMain.handle()`
2. Expose method in `electron/preload.js` via `contextBridge`
3. Optionally wrap in `src/services/ipc.js` for convenience
4. Call from React components via `window.electronAPI`

When adding database operations:
- Implement core logic in `electron/database/` modules
- Use existing connection pool via `getPool(serverId, database)`
- Handle errors and return structured responses
- Never expose raw error messages that may contain credentials
